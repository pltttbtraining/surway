<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ยิ้มรับดอกสูง — Promotion Calculate</title>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

<!-- fonts -->
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@600;800;900&family=Noto+Sans+Thai:wght@400;700&display=swap" rel="stylesheet">

<style>
:root{
  --navy:#002855;
  --led:#3fa9f5;
  --glass-bg: rgba(255,255,255,0.55);
  --muted:#6b7280;
  --bg:#f4f7fb;
  --card:#ffffff;
  --gradient-start:#6b64ff;
  --gradient-end:#4aa3ff;
  --accent:#a6d8ff;
  font-family: "Noto Sans Thai", "Nunito", Arial, sans-serif;
}

/* Reset */
*{box-sizing:border-box}
body{ margin:0; background:var(--bg); color:#08111a; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
a{ color:inherit; text-decoration:none }

/* layout */
.app{ max-width:1100px; margin:18px auto; padding:18px; }
.header{ display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px; }
.title{ font-size:20px; color:var(--navy); font-weight:900; }
.produces{ color:var(--muted); font-size:13px; }

/* progress bar */
.progress{ display:flex; align-items:center; gap:12px; margin-bottom:18px; }
.step{ display:flex; align-items:center; gap:12px; }
.dot{ width:40px; height:40px; border-radius:50%; background:#e6eef8; display:flex; align-items:center; justify-content:center; font-weight:800; color:#9aa4b2; position:relative; }
.dot.active{ background:linear-gradient(180deg,var(--gradient-start),var(--gradient-end)); color:white; box-shadow:0 8px 28px rgba(74,163,255,0.14); transform:translateY(-2px); }
.connector{ flex:1; height:6px; background:#e9eefc; border-radius:6px; }

/* pages */
.page{ display:none; opacity:0; transform:translateY(6px); transition:all .28s ease; }
.page.active{ display:block; opacity:1; transform:none; }

/* glass buttons */
.group-buttons{ display:flex; gap:12px; margin:10px 0 18px 0; }
.glass-btn{
  flex:1; padding:16px; border-radius:12px; text-align:center; cursor:pointer; font-weight:800;
  background: linear-gradient(180deg, rgba(255,255,255,0.65), rgba(245,249,251,0.62));
  border:1px solid rgba(255,255,255,0.6); box-shadow:0 8px 20px rgba(2,6,23,0.04);
  transition:all .22s ease;
}
.glass-btn .label{ display:block; font-size:16px; color:var(--navy); }
.glass-btn.active{ background: linear-gradient(180deg, #e8f4ff, #e8f8ff); border:2px solid var(--led); color:var(--navy); box-shadow:0 14px 36px rgba(63,169,245,0.12); transform:translateY(-6px); }
.glass-btn.dim{ opacity:0.35; transform:none; box-shadow:none; }

/* product cards */
.prod-list{ display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px; margin-top:12px; }
.pro-card{
  background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(250,250,250,0.95));
  border-radius:12px; padding:12px; cursor:pointer; border:1px solid rgba(11,18,32,0.04);
  transition: transform .28s ease, box-shadow .28s ease, opacity .18s ease;
  transform-origin: top center;
  overflow:hidden;
}
.pro-card.enter{ animation: slideDown .36s ease both; }
@keyframes slideDown{ from{ transform:translateY(-16px) scale(.98); opacity:0 } to{ transform:none; opacity:1 } }
.pro-card.selected{ transform:translateY(-8px); box-shadow:0 18px 48px rgba(63,169,245,0.08); border:1px solid rgba(63,169,245,0.12); background: linear-gradient(180deg, rgba(235,249,255,0.85), rgba(245,250,255,0.78)); }
.pro-card.dim{ opacity:0.4; filter:grayscale(12%); }

/* usp collapse */
.usp{ max-height:0; overflow:hidden; transition:all .34s cubic-bezier(.2,.9,.2,1); opacity:0; transform:translateY(-6px); }
.usp.open{ max-height:300px; opacity:1; transform:translateY(0); padding-top:8px; }

/* form */
.form{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px; }
.form .full{ grid-column:1/-1; }
label{ display:block; font-weight:800; color:var(--navy); margin-bottom:6px; }
input, select, textarea{ width:100%; padding:10px; border-radius:8px; border:1px solid rgba(11,18,32,0.06); background:white; }
.range-wrap{ display:flex; gap:12px; align-items:center; }
.range-value{ width:80px; text-align:center; font-weight:900; color:var(--navy); }

/* dashboard summary styles (match image style) */
.summary-card{
  background: linear-gradient(180deg,#eef6ff,#f8fbff);
  border-radius:16px; padding:18px; box-shadow: 0 12px 36px rgba(13,35,67,0.06); border:1px solid rgba(11,18,32,0.04);
}
.total-wrap{ display:flex; gap:16px; align-items:center; }
.total-left{ flex:1; }
.total-title{ font-size:13px; color:var(--muted); margin-bottom:8px; }
.total-number{ font-size:44px; font-weight:900; color:var(--navy); padding:12px 16px; border-radius:10px; background:linear-gradient(90deg, rgba(255,255,255,0.6), rgba(255,255,255,0.3)); display:inline-block; }
.small-cards{ display:flex; gap:12px; margin-top:14px; flex-wrap:wrap; }
.small-card{ background: linear-gradient(180deg, rgba(12,58,107,0.95), rgba(17,70,128,0.95)); color:white; padding:12px; border-radius:10px; flex:1; min-width:200px; box-shadow:0 10px 30px rgba(10,85,150,0.12); }
.small-card .label{ font-size:12px; opacity:0.9; }
.small-card .value{ font-weight:800; font-size:18px; margin-top:8px; }

/* transaction block */
.trans-wrap{ margin-top:16px; border-radius:12px; overflow:hidden; box-shadow:0 12px 36px rgba(11,18,32,0.06); }
.trans-head{ background: linear-gradient(90deg,var(--gradient-start),var(--gradient-end)); color:white; padding:12px 16px; display:flex; justify-content:space-between; align-items:center; }
.trans-body{ padding:14px; background:#fff; display:grid; gap:10px; }
.row-item{ display:flex; justify-content:space-between; align-items:center; padding:10px; border-radius:8px; background: linear-gradient(90deg,#f6f8ff,#f2f7ff); }

/* final */
.final-strip{ margin-top:14px; background:#e6fff3; border-radius:12px; padding:12px; text-align:center; box-shadow:0 8px 22px rgba(18,95,70,0.06); }
.final-strip .num{ font-size:34px; font-weight:900; color:#0b6b4a; }

/* footer buttons */
.controls{ display:flex; gap:10px; justify-content:flex-end; margin-top:12px; }
.btn{ padding:10px 14px; border-radius:10px; border:none; cursor:pointer; font-weight:800; }
.btn.ghost{ background:transparent; border:1px solid rgba(11,18,32,0.06); color:var(--navy); }
.btn.primary{ background:linear-gradient(90deg,var(--gradient-start),var(--gradient-end)); color:white; box-shadow:0 10px 28px rgba(74,163,255,0.14); }

/* responsive */
@media(max-width:900px){
  .form{ grid-template-columns:1fr; }
  .group-buttons{ flex-direction:column; }
  .total-number{ font-size:34px; }
  .small-cards{ flex-direction:column; }
}

/* print */
@media print{
  body{ background:white; }
  .app{ padding:0; margin:0; }
  .controls, .header { display:none; }
}
</style>
</head>
<body>
<div class="app">

  <div class="header">
    <div>
      <div class="title">ยิ้มรับดอกสูง — Promotion Calculate</div>
      <div class="produces">Produces: <strong>Yannapat &amp; Nantida</strong> [PRU Academy RH5]</div>
    </div>
    <div class="small" style="text-align:right;color:var(--muted)">Client-side demo • No data stored</div>
  </div>

  <!-- progress -->
  <div class="progress" aria-hidden="false">
    <div class="step">
      <div id="dot1" class="dot active">1</div>
      <div style="font-size:13px;color:var(--muted)">เลือกผลิตภัณฑ์</div>
    </div>
    <div class="connector"></div>
    <div class="step">
      <div id="dot2" class="dot">2</div>
      <div style="font-size:13px;color:var(--muted)">ข้อมูลลูกค้า</div>
    </div>
    <div class="connector"></div>
    <div class="step">
      <div id="dot3" class="dot">3</div>
      <div style="font-size:13px;color:var(--muted)">สรุปผล</div>
    </div>
  </div>

  <!-- PAGE 1 -->
  <div id="page1" class="page active">
    <label style="font-weight:900; color:var(--navy);">1) เลือกประเภทผลิตภัณฑ์</label>
    <div class="small" style="margin-bottom:8px;color:var(--muted)">กดปุ่มเพื่อเลือกกลุ่มผลิตภัณฑ์</div>

    <div class="group-buttons">
      <div id="btnWealth" class="glass-btn">
        <span class="label">Wealth</span>
      </div>
      <div id="btnSaving" class="glass-btn">
        <span class="label">Saving</span>
      </div>
    </div>

    <div id="prodWrap" class="prod-list" aria-live="polite"></div>

    <div style="display:flex; justify-content:flex-end; margin-top:12px;">
      <button id="page1Next" class="btn primary">ต่อไป</button>
    </div>
  </div>

  <!-- PAGE 2 -->
  <div id="page2" class="page">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <div>
        <label style="font-weight:900; color:var(--navy);">2) ข้อมูลลูกค้า & โปรโมชั่น</label>
        <div class="small" style="color:var(--muted)">กรอกเบี้ย / ทุน (optional) / อายุ — ระบบจะคำนวณ SA ถ้าว่าง</div>
      </div>
      <div>
        <button id="backTo1" class="btn ghost">ย้อนกลับ</button>
      </div>
    </div>

    <div class="form" style="margin-top:12px;">
      <div>
        <label>เบี้ยประกันต่อปี (บาท)</label>
        <input id="inputPremium" type="number" value="100000">
      </div>
      <div>
        <label>ทุนประกัน (Sum Assured — optional)</label>
        <input id="inputSA" type="number" placeholder="เว้นว่างระบบคำนวณให้">
      </div>

      <div>
        <label>อายุ (ปี)</label>
        <input id="inputAge" type="number" value="38">
      </div>
      <div>
        <label>เพศ</label>
        <select id="inputSex"><option value="M">ชาย</option><option value="F">หญิง</option></select>
      </div>

      <div class="full">
        <label>โปรโมชั่น TD (เลือก)</label>
        <div style="display:flex; gap:8px;">
          <button id="promoA" class="glass-btn">ทางเลือก A (TD 36)</button>
          <button id="promoB" class="glass-btn">ทางเลือก B (TD 6)</button>
        </div>
      </div>

      <div class="full">
        <label>ระยะเวลาโปรโมชั่น (เดือน)</label>
        <select id="promoMonths"><option value="36">36</option><option value="6">6</option></select>
      </div>

      <div class="full">
        <label>จำนวนเท่า (Multiplier)</label>
        <div class="range-wrap">
          <input id="multSlider" type="range" min="1" max="50" step="0.5" value="10" style="flex:1;">
          <div class="range-value" id="multValue">10x</div>
        </div>
      </div>

      <div class="full">
        <div id="autoInfo" class="small" style="color:var(--muted);"></div>
      </div>
    </div>

    <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px;">
      <button id="page2Reset" class="btn ghost">รีเซ็ต</button>
      <button id="page2Next" class="btn primary">คำนวณและดูผล</button>
    </div>
  </div>

  <!-- PAGE 3 -->
  <div id="page3" class="page">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <div>
        <label style="font-weight:900; color:var(--navy);">3) ผลการคำนวณ</label>
        <div class="small" style="color:var(--muted)">สรุปผล, ตาราง และ IRR</div>
      </div>
      <div>
        <button id="backTo2" class="btn ghost">ย้อนกลับ</button>
      </div>
    </div>

    <!-- tabs -->
    <div style="display:flex; gap:8px; margin-top:12px;">
      <div id="tabSummary" class="tabBtn btn primary" style="padding:8px 12px; border-radius:8px;">สรุปผลตอบแทน</div>
      <div id="tabInsurance" class="tabBtn btn ghost" style="padding:8px 12px; border-radius:8px;">ผลประโยชน์ (ประกัน)</div>
      <div id="tabDeposit" class="tabBtn btn ghost" style="padding:8px 12px; border-radius:8px;">ผลประโยชน์ (เงินฝาก)</div>
    </div>

    <!-- Summary content -->
    <div id="tabSummaryContent" style="margin-top:12px;">
      <div class="summary-card">
        <div class="total-wrap">
          <div class="total-left">
            <div class="total-title">ผลตอบแทนรวมสุทธิ</div>
            <div id="outTotal" class="total-number">- ฿</div>

            <div class="small-cards">
              <div class="small-card">
                <div class="label">ผลตอบแทนจากประกัน (หักค่าเบี้ย)</div>
                <div id="outInsurance" class="value">- ฿</div>
                <div class="small" style="opacity:0.9; margin-top:6px;">ระยะชำระ: <span id="outPayTerm">-</span> • คุ้มครอง: <span id="outCover">-</span></div>
              </div>
              <div class="small-card">
                <div class="label">ผลตอบแทนจากเงินฝาก (หลังหักภาษี)</div>
                <div id="outDeposit" class="value">- ฿</div>
                <div class="small" style="opacity:0.9; margin-top:6px;">อัตรา TD: <span id="outTdRate">-</span> • ระยะ: <span id="outTdMonths">-</span></div>
              </div>
            </div>
          </div>

          <div style="width:300px; display:flex; flex-direction:column; gap:12px;">
            <div style="background:#fff; border-radius:10px; padding:12px; box-shadow:0 8px 20px rgba(11,18,32,0.04);">
              <div style="font-size:13px; color:var(--muted)">IRR (Blended)</div>
              <div id="outIrr" style="font-weight:900; font-size:20px; color:var(--navy); margin-top:8px;">-</div>
            </div>
            <div style="background:#fff; border-radius:10px; padding:12px; box-shadow:0 8px 20px rgba(11,18,32,0.04);">
              <div style="font-size:13px; color:var(--muted)">Equivalent savings rate</div>
              <div id="outEquiv" style="font-weight:900; font-size:20px; color:var(--navy); margin-top:8px;">-</div>
            </div>
          </div>
        </div>

        <div class="trans-wrap">
          <div class="trans-head">
            <div style="font-weight:800">Transaction</div>
            <div class="small" style="opacity:0.9">รายละเอียด</div>
          </div>
          <div class="trans-body">
            <div class="row-item"><div>IRR</div><div id="transIrr"><strong>-</strong></div></div>
            <div class="row-item"><div>Equivalent deposit rate</div><div id="transEquiv"><strong>-</strong></div></div>

            <div style="display:flex; gap:10px; align-items:center; justify-content:space-between;">
              <div>
                <label style="font-weight:800; color:var(--muted)">ใช้สิทธิลดหย่อนภาษีหรือไม่</label>
                <div style="margin-top:6px;">
                  <label><input id="useTax" type="checkbox"> ใช้</label>
                </div>
              </div>

              <div style="width:220px;">
                <div style="font-size:13px; color:var(--muted)">ฐานภาษี (บาท)</div>
                <input id="taxBase" type="number" value="100000" style="width:100%; padding:8px; border-radius:6px; border:1px solid #eef4ff;" />
                <div style="font-size:13px; color:var(--muted); margin-top:8px;">อัตราภาษี (%)</div>
                <input id="taxRate" type="number" value="10" style="width:100%; padding:8px; border-radius:6px; border:1px solid #eef4ff;" />
              </div>
            </div>

            <div class="row-item" style="margin-top:6px;"><div>ผลประโยชน์ภาษี (approx.)</div><div id="taxBenefit"><strong>- ฿</strong></div></div>
          </div>
        </div>

        <div class="final-strip">
          <div class="small" style="margin-bottom:6px;">ผลประโยชน์รวมสุทธิ หลังภาษี (ถ้ามี)</div>
          <div id="finalNet" class="num">- ฿</div>
        </div>

        <div class="controls">
          <button id="exportPdf" class="btn primary">ส่งเป็น PDF</button>
          <button id="downloadCsv" class="btn ghost">ดาวน์โหลด CSV</button>
        </div>
      </div>
    </div>

    <!-- Insurance content -->
    <div id="tabInsuranceContent" style="display:none; margin-top:12px;">
      <h3 style="margin:0;color:var(--navy)">ตารางผลประโยชน์ (ประกัน)</h3>
      <div class="small" style="color:var(--muted)">ดูผลประโยชน์รายปี — ถ้า period &gt; 20 ปี: แสดง 5 ปีแรก + ... + 5 ปีสุดท้าย</div>
      <div id="insuranceTableArea" style="margin-top:10px;"></div>

      <div style="margin-top:12px;">
        <h4>สรุปประโยชน์ประกัน</h4>
        <div style="display:flex; gap:12px; margin-top:8px;">
          <div style="flex:1; background:#fff; padding:12px; border-radius:10px; box-shadow:0 8px 20px rgba(11,18,32,0.04);">
            <div style="font-size:13px; color:var(--muted)">เบี้ยรวม</div>
            <div id="sumPremium" style="font-weight:900; margin-top:8px;">- ฿</div>
          </div>
          <div style="flex:1; background:#fff; padding:12px; border-radius:10px; box-shadow:0 8px 20px rgba(11,18,32,0.04);">
            <div style="font-size:13px; color:var(--muted)">เงินคืนรวม</div>
            <div id="sumGuaranteed" style="font-weight:900; margin-top:8px;">- ฿</div>
          </div>
          <div style="flex:1; background:#fff; padding:12px; border-radius:10px; box-shadow:0 8px 20px rgba(11,18,32,0.04);">
            <div style="font-size:13px; color:var(--muted)">ผลประโยชน์สุทธิ (ประกัน)</div>
            <div id="sumNetInsurance" style="font-weight:900; margin-top:8px;">- ฿</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Deposit content -->
    <div id="tabDepositContent" style="display:none; margin-top:12px;">
      <h3 style="margin:0;color:var(--navy)">ตารางผลประโยชน์ (เงินฝาก)</h3>
      <div id="depositTableArea" style="margin-top:10px;"></div>

      <div style="margin-top:12px; display:flex; gap:12px;">
        <div style="flex:1; background:#fff; padding:12px; border-radius:10px; box-shadow:0 8px 20px rgba(11,18,32,0.04);">
          <div style="font-size:13px; color:var(--muted)">ดอกเบี้ยรวม (ก่อนภาษี)</div>
          <div id="depositGross" style="font-weight:900; margin-top:8px;">- ฿</div>
        </div>
        <div style="flex:1; background:#fff; padding:12px; border-radius:10px; box-shadow:0 8px 20px rgba(11,18,32,0.04);">
          <div style="font-size:13px; color:var(--muted)">ดอกเบี้ยรวม (หลังหักภาษี 15%)</div>
          <div id="depositNet" style="font-weight:900; margin-top:8px;">- ฿</div>
        </div>
      </div>
    </div>

  </div>

</div>

<script>
/* ---------------------------
  PRODUCTS & RATES (Logic Engine)
  - Use these data structures for SA, benefits, pay terms, etc.
  - Replace AGE_RATE with Actuary tables for production.
-----------------------------*/
const PRODUCTS = {
  wealth: [
    { code:'global_index_plus', name:'ทีทีบี โกลบอล อินเด็กซ์ พรินซิเพิล โพรเทค 15/5 พลัส', pay_term:5, cover_term:15, fixed_rate_per_1000:1000,
      benefits:[{year:2,pct:2.5},{year:4,pct:2.5},{year:6,pct:2.5},{year:8,pct:2.5},{year:10,pct:2.5},{year:12,pct:2.5},{year:14,pct:2.5},{year:15,pct:500}] },
    { code:'global_index_max', name:'ทีทีบี โกลบอล อินเด็กซ์ 15/5 แม็กซ์', pay_term:5, cover_term:15, fixed_rate_per_1000:1000,
      benefits:[{year:2,pct:1},{year:4,pct:1},{year:6,pct:1},{year:8,pct:1},{year:10,pct:1},{year:12,pct:1},{year:14,pct:1},{year:15,pct:500}] },
    { code:'wealth_99_5', name:'ทีทีบี ส่งต่อความมั่งคั่ง 99/5', pay_term:5, cover_term:99, variable:true, benefits:[{year:99,pct:100}] },
    { code:'happy_life', name:'ทีทีบี แฮปปี้ ไลฟ์ โพรเทค', pay_term:5, cover_term:99, variable:true, benefits:[{year:99,pct:100}] },
    { code:'ultimate_99_3', name:'ทีทีบี อัลติเมท เลกาซี 99/3', pay_term:3, cover_term:99, variable:true, benefits:[{year:99,pct:100}] },
    { code:'treasure_all', name:'ทีทีบี เดอะ เทรเชอร์ (ทุกแผน)', pay_term:8, cover_term:88, variable:true, usp:'มรดก + บำนาญ รับเงินคืนต่อเนื่อง', benefits:[] }
  ],
  saving: [
    { code:'money_saver_14_6', name:'ทีทีบี มันนี่ เซฟเวอร์ 14/6', pay_term:6, cover_term:14, variable:true, benefits:[...Array.from({length:13},(_,i)=>({year:i+1,pct:2.3})), {year:14,pct:140}] },
    { code:'smart_bonus_10_5', name:'ทีทีบี สมาร์ท โบนัส 10/5', pay_term:5, cover_term:10, fixed_rate_per_1000:1000, benefits:[{year:2,pct:1},{year:4,pct:1},{year:6,pct:1},{year:8,pct:1},{year:10,pct:100}]},
    { code:'money_saver_15_6', name:'ทีทีบี มันนี่ เซฟเวอร์ 15/6', pay_term:6, cover_term:15, variable:true, benefits:[...Array.from({length:14},(_,i)=>({year:i+1,pct:2.5})), {year:15,pct:150}]},
    { code:'premium_saver_11_3', name:'ทีทีบี พรีเมียม เซฟเวอร์ 11/3', pay_term:3, cover_term:11, fixed_rate_per_1000:1000, benefits:[{year:2,pct:1},{year:4,pct:1},{year:6,pct:1},{year:8,pct:1},{year:10,pct:1},{year:11,pct:349.5}]}
  ]
};

const PROMO_MULTIPLIERS = { wealth: {A:20,B:15}, saving: {A:10,B:7.5} };
const DEFAULT_TD = { '36':1.50, '6':1.25 };

/* sample AGE_RATE (placeholder): replace with Actuary table */
const AGE_RATE = {
  money_saver_15_6: (age)=> { if(age<=40) return 260; if(age<=45) return 265; if(age<=50) return 270; if(age<=55) return 275; if(age<=60) return 280; return 294; },
  money_saver_14_6: (age)=> { if(age<=40) return 255; if(age<=45) return 260; if(age<=50) return 265; if(age<=55) return 270; return 300; },
  wealth_99_5: (age)=> Math.max(800,1000 + (age-30)*10),
  happy_life: (age)=> Math.max(800,1000 + (age-30)*12),
  ultimate_99_3: (age)=> Math.max(900,1000 + (age-30)*14),
  treasure_all: (age)=> Math.max(900,1000 + (age-30)*12)
};

/* helpers */
function money(x){ return Number(x).toLocaleString('en-US',{minimumFractionDigits:2, maximumFractionDigits:2}); }
function daysBetween(d1,d2){ return (d2 - d1) / (1000*60*60*24); }

/* xnpv and numeric solver (Brent) */
function xnpv(rate, cfs){
  const ref = cfs.reduce((a,b)=> a.date < b.date ? a : b.date, cfs[0].date);
  return cfs.reduce((acc,it)=> {
    const t = daysBetween(ref, it.date)/365;
    return acc + it.cf / Math.pow(1 + rate, t);
  }, 0);
}

function brent(f,a,b,tol=1e-12,maxIter=200){
  let fa=f(a), fb=f(b);
  if(!isFinite(fa) || !isFinite(fb)) return null;
  if(fa === 0) return a; if(fb === 0) return b;
  if(fa * fb > 0) return null;
  let c=a, fc=fa, d=b-a, e=d;
  for(let iter=0; iter<maxIter; iter++){
    if(fb === 0) return b;
    if(fa * fb > 0){ a=c; fa=fc; d=b-c; e=d; }
    if(Math.abs(fa) < Math.abs(fb)){ c=b; b=a; a=c; fc=fb; fb=fa; fa=fc; }
    const tol1 = 2.220446049250313e-16 * Math.abs(b) + tol/2;
    const xm = (a-b)/2;
    if(Math.abs(xm) <= tol1 || fb === 0) return b;
    if(Math.abs(e) >= tol1 && Math.abs(fc) > Math.abs(fb)){
      let s = fb/fc, p, q;
      if(a === c){ p = 2 * xm * s; q = 1 - s; }
      else { q = fc/fa; const r = fb/fa; p = s * (2*xm * q * (q - r) - (b - c)*(r -1)); q = (q -1)*(r -1)*(s -1); }
      if(p > 0) q = -q; else p = -p;
      const min1 = 3 * xm * q - Math.abs(tol1 * q);
      const min2 = Math.abs(e * q);
      if(2*p < (min1 < min2 ? min1 : min2)) { e = d; d = p / q; } else { d = xm; e = d; }
    } else { d = xm; e = d; }
    a = b; fa = fb;
    if(Math.abs(d) > tol1) b += d; else b += (xm > 0 ? tol1 : -tol1);
    fb = f(b);
    if((fb > 0 && fc > 0) || (fb < 0 && fc < 0)){ c = a; fc = fa; d = b - a; e = d; }
  }
  return null;
}

function findXIRRs(cfs){
  const f = r => xnpv(r, cfs);
  const roots = [];
  const minR = -0.999999, maxR = 20, steps = 600;
  let prevR = minR; let prevF = f(prevR); const del = (maxR - minR) / steps;
  for(let i=1;i<=steps;i++){
    const r = minR + i*del; let fr;
    try{ fr = f(r); } catch(e){ fr = NaN; }
    if(isFinite(fr) && isFinite(prevF)){
      if(prevF === 0) roots.push(prevR);
      else if(prevF * fr < 0){
        const root = brent(f, prevR, r, 1e-12, 200);
        if(root !== null && isFinite(root)) if(!roots.some(rt=>Math.abs(rt-root)<1e-9)) roots.push(root);
      }
    }
    prevR = r; prevF = fr;
  }
  return roots.sort((a,b)=>a-b);
}

/* Equivalent savings rate (FV of annual premiums) */
function findEquivalentRate(premium, years, target){
  if(years <= 0) return null;
  const f = r => {
    let fv = 0;
    for(let k=0;k<years;k++){
      fv += premium * Math.pow(1 + r, years -1 - k);
    }
    return fv - target;
  };
  let a = -0.9999, b = 1.0;
  let fa = f(a), fb = f(b);
  for(let i=0;i<60 && fa*fb > 0; i++){ b *= 2; fb = f(b); }
  if(fa*fb > 0) return null;
  const root = brent(f, a, b, 1e-10, 200);
  return root;
}

/* Build cashflows: premiums outflows, insurance inflows, deposit outflow & maturity inflow */
function estimateSA(product, premium, age){
  if(product.fixed_rate_per_1000){
    return (premium / product.fixed_rate_per_1000) * 1000;
  } else {
    const fn = AGE_RATE[product.code] || AGE_RATE[product.code.replace(/[^a-z0-9_]/gi,'')];
    if(typeof fn === 'function') return (premium / fn(age)) * 1000;
    return premium;
  }
}

function buildCashflows(product, premium, saInput, age, promoChoice, promoMonths, multiplier){
  const today = new Date();
  const cfs = [];
  // premiums (annual) — assume at policy anniversary t=0..pay_term-1
  for(let y=0;y<product.pay_term;y++){
    const d = new Date(today.getFullYear()+y, today.getMonth(), today.getDate());
    cfs.push({date:d, cf:-premium, tag:'premium'});
  }
  const SA = (saInput && saInput>0) ? saInput : estimateSA(product, premium, age);
  (product.benefits || []).forEach(b=>{
    const d = new Date(today.getFullYear() + b.year, today.getMonth(), today.getDate());
    const amt = SA * (b.pct/100);
    cfs.push({date:d, cf: amt, tag:'insurance'});
  });
  // deposit principal (customer deposits) - assume deposit occurs at today
  let depositAmount = premium * multiplier;
  if(product && product.group === 'saving'){ depositAmount = Math.min(depositAmount, 200_000_000); }
  cfs.push({date: today, cf:-depositAmount, tag:'deposit-principal'});
  // deposit maturity
  const matDate = new Date(today.getFullYear(), today.getMonth() + Number(promoMonths), today.getDate());
  const tdRate = DEFAULT_TD[String(promoMonths)] || 1.25;
  const years = daysBetween(today, matDate)/365;
  const matAmount = depositAmount * Math.pow(1 + tdRate/100, years);
  cfs.push({date: matDate, cf: matAmount, tag:'deposit-maturity'});
  return { cfs, SA, depositAmount, matAmount, matDate, today, tdRate };
}

/* Render/UI wiring */
const prodWrap = document.getElementById('prodWrap');
const btnWealth = document.getElementById('btnWealth'), btnSaving = document.getElementById('btnSaving');
const page1 = document.getElementById('page1'), page2 = document.getElementById('page2'), page3 = document.getElementById('page3');
const dot1 = document.getElementById('dot1'), dot2 = document.getElementById('dot2'), dot3 = document.getElementById('dot3');

let activeGroup = null;
let selectedProduct = null;

function clearSelectionButtons(){
  btnWealth.classList.remove('active'); btnSaving.classList.remove('active');
  btnWealth.classList.remove('dim'); btnSaving.classList.remove('dim');
}

btnWealth.addEventListener('click', ()=>{
  clearSelectionButtons();
  activeGroup = 'wealth';
  btnWealth.classList.add('active');
  btnSaving.classList.add('dim');
  showProducts('wealth');
});
btnSaving.addEventListener('click', ()=>{
  clearSelectionButtons();
  activeGroup = 'saving';
  btnSaving.classList.add('active');
  btnWealth.classList.add('dim');
  showProducts('saving');
});

function showProducts(group){
  prodWrap.innerHTML = '';
  const list = PRODUCTS[group];
  list.forEach((p, idx) => {
    const el = document.createElement('div'); el.className = 'pro-card enter';
    el.innerHTML = `<div style="font-weight:800">${p.name}</div><div class="small" style="margin-top:6px;color:${p.variable?'#6b7280':'#6b7280'}">ระยะชำระ: ${p.pay_term} ปี • คุ้มครอง: ${p.cover_term} ปี</div><div class="usp" id="usp-${p.code}">${p.usp ? '<div style="margin-top:8px;color:var(--muted)">'+p.usp+'</div>':''}<div style="margin-top:8px;"><em class="small">เงินคืนตัวอย่าง (guaranteed): ${p.benefits && p.benefits.length? p.benefits.map(b=> b.year===p.cover_term? (b.pct+'% at maturity') : (b.pct+'% at Y'+b.year)).slice(0,3).join(', ') : '-'}</em></div></div>`;
    el.onclick = ()=>{
      // mark selected
      Array.from(prodWrap.children).forEach(ch=> ch.classList.remove('selected'));
      el.classList.add('selected');
      selectedProduct = Object.assign({}, p, { group });
      // open USP area
      const uspEls = document.querySelectorAll('.usp'); uspEls.forEach(u=> u.classList.remove('open'));
      const usp = el.querySelector('.usp'); if(usp) usp.classList.add('open');
      // dim others
      Array.from(prodWrap.children).forEach(ch=> { if(!ch.classList.contains('selected')) ch.classList.add('dim'); else ch.classList.remove('dim'); });
    };
    prodWrap.appendChild(el);
  });
}

/* navigation */
function gotoPage(n){
  [page1,page2,page3].forEach(p=> p.classList.remove('active'));
  [dot1,dot2,dot3].forEach(d=> d.classList.remove('active'));
  if(n===1){ page1.classList.add('active'); dot1.classList.add('active'); }
  if(n===2){ page2.classList.add('active'); dot2.classList.add('active'); }
  if(n===3){ page3.classList.add('active'); dot3.classList.add('active'); }
}

document.getElementById('page1Next').addEventListener('click', ()=>{
  if(!selectedProduct){ alert('กรุณาเลือกผลิตภัณฑ์ก่อน'); return; }
  gotoPage(2);
  updateAutoInfo();
});

document.getElementById('backTo1').addEventListener('click', ()=> gotoPage(1));
document.getElementById('backTo2').addEventListener('click', ()=> gotoPage(2));

/* page2 controls */
const inputPremium = document.getElementById('inputPremium'), inputSA = document.getElementById('inputSA'), inputAge = document.getElementById('inputAge'), inputSex = document.getElementById('inputSex');
const promoA = document.getElementById('promoA'), promoB = document.getElementById('promoB'), promoMonths = document.getElementById('promoMonths');
const multSlider = document.getElementById('multSlider'), multValue = document.getElementById('multValue'), autoInfo = document.getElementById('autoInfo');
promoA.addEventListener('click', ()=> { promoA.classList.add('active'); promoB.classList.remove('active'); promoMonths.value='36'; updateAutoInfo(); });
promoB.addEventListener('click', ()=> { promoB.classList.add('active'); promoA.classList.remove('active'); promoMonths.value='6'; updateAutoInfo(); });
multSlider.addEventListener('input', ()=> multValue.innerText = multSlider.value + 'x');
document.getElementById('page2Reset').addEventListener('click', ()=>{
  inputPremium.value=100000; inputSA.value=''; inputAge.value=38; inputSex.value='M';
  multSlider.value=10; multValue.innerText='10x'; promoMonths.value='36'; promoA.classList.remove('active'); promoB.classList.remove('active');
  updateAutoInfo();
});

function updateAutoInfo(){
  const premium = Number(inputPremium.value||0);
  if(!selectedProduct){ autoInfo.innerHTML = '<span style="color:#c0392b">กรุณาเลือกผลิตภัณฑ์ก่อน</span>'; return; }
  const group = selectedProduct.group || activeGroup;
  const choice = promoMonths.value === '36' ? 'A' : 'B';
  const allowed = PROMO_MULTIPLIERS[group][choice];
  const capText = (group === 'saving') ? ' (แต่ไม่เกิน 200,000,000 บาท)' : '';
  const eligible = premium >= 50000;
  autoInfo.innerHTML = `ระบบคำนวณอัตโนมัติ: โปรโมชั่นที่เป็นไปได้: <strong>TD ${promoMonths.value} เดือน</strong>. ฝากได้สูงสุด <strong>${allowed} เท่า</strong> ${capText}. ${eligible ? '' : '<span style="color:#c0392b">หมายเหตุ: หากเบี้ยน้อยกว่า 50,000 บาท จะไม่ได้รับสิทธิ์ฝากพิเศษ</span>'}`;
}

/* calculation and render results */
function renderResults(){
  const premium = Number(inputPremium.value||0);
  const saInput = Number(inputSA.value||0);
  const age = Number(inputAge.value||0);
  const sex = inputSex.value;
  const promoChoice = promoMonths.value === '36' ? 'A' : 'B';
  const promoMonthsVal = Number(promoMonths.value);
  const multiplierVal = Number(multSlider.value);
  if(!selectedProduct){ alert('No product selected'); gotoPage(1); return; }
  if(premium <= 0){ alert('กรุณากรอกเบี้ยประกัน'); gotoPage(2); return; }

  selectedProduct.group = selectedProduct.group || activeGroup;

  const built = buildCashflows(selectedProduct, premium, saInput, age, promoChoice, promoMonthsVal, multiplierVal);
  const cfs = built.cfs;

  // XIRR
  const roots = findXIRRs(cfs);
  let irr = null, meta = '';
  if(roots.length === 0) meta = 'ไม่พบ IRR';
  else if(roots.length === 1){ irr = roots[0]; meta = 'single root'; }
  else { irr = roots[roots.length-1]; meta = 'multiple roots - showing highest'; }

  // totals
  const inflows = cfs.filter(it=>it.cf>0).reduce((a,b)=>a+b.cf,0);
  const outflows = cfs.filter(it=>it.cf<0).reduce((a,b)=>a+Math.abs(b.cf),0);
  const net = inflows - outflows;

  // insurance figures
  const insuranceInflows = cfs.filter(it=>it.tag==='insurance').reduce((a,b)=>a+b.cf,0);
  const premiumsPaid = cfs.filter(it=>it.tag==='premium').reduce((a,b)=>a+Math.abs(b.cf),0);
  const insuranceNet = insuranceInflows - premiumsPaid;

  // deposit
  const depositPrincipal = Math.abs(cfs.find(it=>it.tag==='deposit-principal').cf);
  const depositMat = cfs.find(it=>it.tag==='deposit-maturity').cf;
  const depositInterestGross = Math.max(0, depositMat - depositPrincipal);
  const depositInterestNet = depositInterestGross * (1 - 0.15);

  // equivalent rate
  const horizonYears = Math.max(selectedProduct.cover_term || 15, Math.ceil((built.matDate - built.today)/(1000*60*60*24*365)));
  const equiv = findEquivalentRate(premium, horizonYears, inflows);

  // tax
  const useTax = document.getElementById('useTax').checked;
  const taxBase = Number(document.getElementById('taxBase').value||0);
  const taxRate = Number(document.getElementById('taxRate').value||0)/100;
  const taxSaving = useTax ? Math.min(premiumsPaid, taxBase) * taxRate : 0;

  // render to UI
  document.getElementById('outTotal').innerText = money(net) + ' ฿';
  document.getElementById('outInsurance').innerText = money(Math.max(0,insuranceNet)) + ' ฿';
  document.getElementById('outDeposit').innerText = money(depositInterestNet) + ' ฿';
  document.getElementById('outPayTerm').innerText = selectedProduct.pay_term + ' ปี';
  document.getElementById('outCover').innerText = selectedProduct.cover_term + ' ปี';
  document.getElementById('outTdRate').innerText = (built.tdRate || 0).toFixed(2) + '%';
  document.getElementById('outTdMonths').innerText = (promoMonthsVal) + ' เดือน';
  document.getElementById('outIrr').innerText = (irr === null ? 'N/A' : ( (irr*100).toFixed(4) + '%' )) ;
  document.getElementById('outEquiv').innerText = (equiv === null ? 'N/A' : ((equiv*100).toFixed(4) + '%'));
  document.getElementById('transIrr').innerHTML = '<strong>' + (irr === null ? 'N/A' : ((irr*100).toFixed(4) + '%')) + '</strong>';
  document.getElementById('transEquiv').innerHTML = '<strong>' + (equiv === null ? 'N/A' : ((equiv*100).toFixed(4) + '%')) + '</strong>';
  document.getElementById('taxBenefit').innerHTML = '<strong>' + money(taxSaving) + ' ฿</strong>';
  document.getElementById('finalNet').innerText = money(net + taxSaving) + ' ฿';
  document.getElementById('outIrr').setAttribute('title', meta);

  // insurance table
  renderInsuranceTable(cfs, built, selectedProduct, premium, age);

  // deposit table
  renderDepositTable(depositPrincipal, depositMat, depositInterestGross, depositInterestNet, built);

  // populate summary numbers used in CSV
  lastResult = { built, cfs, irr, net, insuranceNet, depositInterestGross, depositInterestNet, premiumsPaid, taxSaving, equiv };
  gotoPage(3);
}

/* render insurance table with >20 rule */
let lastResult = null;
function renderInsuranceTable(cfs, built, product, premium, age){
  const refYear = built.today.getFullYear();
  const yearMap = {};
  cfs.forEach(it=>{
    const yr = it.date.getFullYear() - refYear;
    if(!yearMap[yr]) yearMap[yr] = [];
    yearMap[yr].push(it);
  });
  const years = Object.keys(yearMap).map(x=>parseInt(x)).sort((a,b)=>a-b);
  const maxYear = years.length ? years[years.length-1] : (product.cover_term || 15);
  let html = '';
  if(maxYear > 20){
    const first5 = Array.from({length:5},(_,i)=>i);
    const last5 = Array.from({length:5},(_,i)=> maxYear -4 + i);
    html += `<div><strong>5 ปีแรก</strong>` + buildInsuranceTable(first5, yearMap, built, premium, age) + `</div>`;
    html += `<div style="margin-top:8px;"><strong>5 ปีสุดท้าย</strong>` + buildInsuranceTable(last5, yearMap, built, premium, age) + `</div>`;
    html += `<div style="margin-top:8px;"><button id="showInsuranceAll" class="btn ghost">แสดงปีทั้งหมด</button></div>`;
  } else {
    const all = Array.from({length:maxYear+1},(_,i)=>i);
    html += buildInsuranceTable(all, yearMap, built, premium, age);
  }
  document.getElementById('insuranceTableArea').innerHTML = html;
  const btn = document.getElementById('showInsuranceAll');
  if(btn) btn.addEventListener('click', ()=> {
    const all = Array.from({length:maxYear+1},(_,i)=>i);
    document.getElementById('insuranceTableArea').innerHTML = buildInsuranceTable(all, yearMap, built, premium, age);
  });
}

function buildInsuranceTable(yearsArr, yearMap, built, premium, age){
  let html = `<table style="width:100%;border-collapse:collapse;"><thead><tr style="text-align:left;"><th>ปี</th><th>อายุ</th><th style="text-align:right">เบี้ยจ่าย/ปี</th><th style="text-align:right">จำนวนเงินคืน</th></tr></thead><tbody>`;
  yearsArr.forEach(y=>{
    const items = yearMap[y] || [];
    const prem = items.filter(it=>it.tag==='premium').reduce((a,b)=>a+Math.abs(b.cf),0);
    const ins = items.filter(it=>it.tag==='insurance').reduce((a,b)=>a+b.cf,0);
    html += `<tr><td>${y}</td><td>${age + y}</td><td style="text-align:right">${prem?money(prem)+' ฿':'-'}</td><td style="text-align:right">${ins?money(ins)+' ฿':'-'}</td></tr>`;
  });
  html += `</tbody></table>`;
  return html;
}

/* deposit table */
function renderDepositTable(principal, matAmount, grossInterest, netInterest, built){
  let html = `<table style="width:100%;border-collapse:collapse;"><thead><tr style="text-align:left;"><th>รายการ</th><th style="text-align:right">จำนวน (บาท)</th><th>หมายเหตุ</th></tr></thead><tbody>`;
  html += `<tr><td>เงินต้น (ฝากพิเศษ)</td><td style="text-align:right">${money(principal)} ฿</td><td>-</td></tr>`;
  html += `<tr><td>ยอดเมื่อครบ</td><td style="text-align:right">${money(matAmount)} ฿</td><td>ครบหลัง ${Math.round(daysBetween(built.today,built.matDate)/365*100)/100} ปี</td></tr>`;
  html += `<tr><td>ดอกเบี้ยรวม (ก่อนหักภาษี)</td><td style="text-align:right">${money(grossInterest)} ฿</td><td>-</td></tr>`;
  html += `<tr><td>ดอกเบี้ยหลังหักภาษี 15%</td><td style="text-align:right">${money(netInterest)} ฿</td><td>-</td></tr>`;
  html += `</tbody></table>`;
  html += `<div style="margin-top:8px;" class="small">สรุป: ดอกเบี้ยรวมหลังหักภาษี (ไม่รวมเงินต้น) = <strong>${money(netInterest)} ฿</strong></div>`;
  document.getElementById('depositTableArea').innerHTML = html;
}

/* exports - CSV & PDF */
document.getElementById('downloadCsv').addEventListener('click', ()=>{
  if(!lastResult){ alert('ไม่มีผลลัพธ์ให้ดาวน์โหลด'); return; }
  const rows=[['date','tag','cashflow']];
  lastResult.cfs.forEach(it=> rows.push([it.date.toISOString().split('T')[0], it.tag, it.cf]));
  const csv = rows.map(r=> r.join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'smilehigh_cfs.csv'; a.click(); URL.revokeObjectURL(url);
});

document.getElementById('exportPdf').addEventListener('click', ()=>{
  const el = document.querySelector('.app');
  const opt = {
    margin:       [10,10,10,10],
    filename:     'SmileHigh_Summary.pdf',
    image:        { type: 'jpeg', quality: 0.98 },
    html2canvas:  { scale: 2, useCORS:true },
    jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
  };
  html2pdf().set(opt).from(el).save();
});

/* tab switching */
document.getElementById('tabSummary').addEventListener('click', ()=> { showTab('summary'); });
document.getElementById('tabInsurance').addEventListener('click', ()=> { showTab('insurance'); });
document.getElementById('tabDeposit').addEventListener('click', ()=> { showTab('deposit'); });
function showTab(k){
  document.getElementById('tabSummaryContent').style.display = 'none';
  document.getElementById('tabInsuranceContent').style.display = 'none';
  document.getElementById('tabDepositContent').style.display = 'none';
  document.getElementById('tabSummary').classList.remove('ghost');
  document.getElementById('tabInsurance').classList.remove('ghost');
  document.getElementById('tabDeposit').classList.remove('ghost');
  document.getElementById('tabSummary').classList.remove('primary');
  document.getElementById('tabInsurance').classList.remove('primary');
  document.getElementById('tabDeposit').classList.remove('primary');
  if(k==='summary'){ document.getElementById('tabSummaryContent').style.display='block'; document.getElementById('tabSummary').classList.add('primary'); }
  if(k==='insurance'){ document.getElementById('tabInsuranceContent').style.display='block'; document.getElementById('tabInsurance').classList.add('primary'); }
  if(k==='deposit'){ document.getElementById('tabDepositContent').style.display='block'; document.getElementById('tabDeposit').classList.add('primary'); }
}

/* wire calculate button */
document.getElementById('page2Next').addEventListener('click', ()=> {
  updateAutoInfo();
  renderResults();
});

/* initial UI */
showTab('summary');

/* bonus: CSV/JSON download of product list */
function exportProductsJSON(){
  const data = { products: PRODUCTS };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download='products.json'; a.click(); URL.revokeObjectURL(url);
}

/* small: show products for initial demo (auto open wealth) */
btnWealth.click();
updateAutoInfo();

/* Optional: allow pressing Enter in premium to calculate */
document.getElementById('inputPremium').addEventListener('keydown', (e)=> { if(e.key==='Enter'){ renderResults(); } });

</script>
</body>
</html>
